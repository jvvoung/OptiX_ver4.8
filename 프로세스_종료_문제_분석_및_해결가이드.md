# OptiX í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë¬¸ì œ ë¶„ì„ ë° í•´ê²° ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [í˜„ìƒ ì •ë¦¬](#í˜„ìƒ-ì •ë¦¬)
2. [ì›ì¸ ë¶„ì„](#ì›ì¸-ë¶„ì„)
3. [ì ê²€ ë° ì¬í˜„ ë°©ë²•](#ì ê²€-ë°-ì¬í˜„-ë°©ë²•)
4. [í•´ê²° ë°©ì•ˆ ì„¤ê³„](#í•´ê²°-ë°©ì•ˆ-ì„¤ê³„)
5. [êµ¬í˜„ ê°€ì´ë“œ](#êµ¬í˜„-ê°€ì´ë“œ)
6. [í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤](#í…ŒìŠ¤íŠ¸-ì‹œë‚˜ë¦¬ì˜¤)

---

## ğŸ“Š í˜„ìƒ ì •ë¦¬

### ë°œìƒ í˜„ìƒ
1. **Exe íŒŒì¼ ì ê¹€**: Exe ì¢…ë£Œ í›„ì—ë„ ê°™ì€ í´ë”ì— ë‹¤ë¥¸ ë²„ì „ Exe ë®ì–´ì“°ê¸°/ë³µì‚¬ ì‹¤íŒ¨
   - ì˜¤ë¥˜ ë©”ì‹œì§€: "í”„ë¡œê·¸ë¨ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
   - ê°„í—ì  ë°œìƒ (ì¬í˜„ì„±ì´ ë‚®ìŒ)

2. **í¬íŠ¸ ì ìœ **: í”„ë¡œê·¸ë¨ ì¬ì‹¤í–‰ ì‹œ ì‹ í˜¸ê¸°/ê³„ì¸¡ê¸° í¬íŠ¸ê°€ ì´ë¯¸ ì ìœ ëœ ìƒíƒœ
   - PGTurn/Meas_Turn í˜¸ì¶œ ì‹œ í¬íŠ¸ ì—°ê²° ì‹¤íŒ¨
   - ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ì´ ì™„ì „íˆ ì¢…ë£Œë˜ì§€ ì•ŠìŒ

3. **í”„ë¡œì„¸ìŠ¤ ì”ì¡´**: ì‘ì—…ê´€ë¦¬ìì—ì„œ í”„ë¡œì„¸ìŠ¤ê°€ ë‚¨ì•„ìˆê±°ë‚˜, ë³´ì´ì§€ ì•Šì§€ë§Œ ë¦¬ì†ŒìŠ¤ê°€ í•´ì œë˜ì§€ ì•ŠìŒ

---

## ğŸ” ì›ì¸ ë¶„ì„

### 1. **í†µì‹  ì„œë²„ ìŠ¤ë ˆë“œ ë¯¸ì •ë¦¬** â­ (ì£¼ìš” ì›ì¸)

**í˜„ì¬ ì½”ë“œ ë¶„ì„** (`MainWindow.xaml.cs:563-584`):
```csharp
protected override void OnClosed(EventArgs e)
{
    // CommunicationServer ì •ë¦¬
    if (communicationServer != null)
    {
        try
        {
            communicationServer.StopServerAsync().Wait(3000);  // âŒ 3ì´ˆ íƒ€ì„ì•„ì›ƒ
            communicationServer.SendMessageToAllClientsAsync("SERVER_SHUTDOWN").Wait(1000);  // âŒ 1ì´ˆ íƒ€ì„ì•„ì›ƒ
            communicationServer.Dispose();
        }
        catch { }
    }
}
```

**ë¬¸ì œì **:
- `CommunicationServer`ëŠ” `AcceptClientsAsync`ì™€ `HandleClientAsync`ë¼ëŠ” **ë‘ ê°œì˜ ë°±ê·¸ë¼ìš´ë“œ Task**ë¥¼ ì‹¤í–‰
- `Wait(timeout)`ì€ Task ì·¨ì†Œë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŒ â†’ **íƒ€ì„ì•„ì›ƒ ë°œìƒ ì‹œ ìŠ¤ë ˆë“œê°€ ê³„ì† ì‹¤í–‰ë¨**
- `CancellationToken`ì´ ì œëŒ€ë¡œ ì „íŒŒë˜ì§€ ì•Šìœ¼ë©´ **ë¬´í•œ ëŒ€ê¸° ë£¨í”„**ì— ë¹ ì§ˆ ìˆ˜ ìˆìŒ
- `TcpListener.AcceptTcpClientAsync()`ëŠ” ì·¨ì†Œ í† í°ì„ ì§€ì›í•˜ì§€ ì•Šì•„ **ë¦¬ìŠ¤ë„ˆê°€ ì •ë¦¬ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ**

**íŒŒì¼ ì ê¹€ ì—°ê²°**:
- ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œê°€ ì‚´ì•„ìˆìœ¼ë©´ â†’ **í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œë˜ì§€ ì•ŠìŒ** â†’ Exe íŒŒì¼ í•¸ë“¤ ìœ ì§€ â†’ íŒŒì¼ ë®ì–´ì“°ê¸° ì‹¤íŒ¨

---

### 2. **Timer ê°ì²´ ë¯¸ì •ë¦¬**

**í˜„ì¬ ì½”ë“œ ë¶„ì„** (`MainWindow.xaml.cs:170-194`):
```csharp
private System.Threading.Timer opticTestTimer;

private void OnOpticTestStartRequested(object sender, OpticStartEventArgs e)
{
    // ...
    opticTestTimer = new System.Threading.Timer(_ =>
    {
        Dispatcher.BeginInvoke(new Action(() =>
        {
            StartOpticTestWithAllZones();
        }));
    }, null, 200, System.Threading.Timeout.Infinite);
}
```

**ë¬¸ì œì **:
- TimerëŠ” ì¢…ë£Œ ì‹œ ëª…ì‹œì ìœ¼ë¡œ `Dispose()`í•´ì•¼ í•¨
- `OnClosed`ì—ì„œ Timer ì •ë¦¬ ì½”ë“œ ì—†ìŒ â†’ **íƒ€ì´ë¨¸ ì½œë°±ì´ ì‹¤í–‰ ì¤‘ì´ë©´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì§€ì—°**

---

### 3. **Semaphore ì •ë¦¬ ëˆ„ë½**

**í˜„ì¬ ì½”ë“œ ë¶„ì„** (`OpticSeqExecutor.cs:52-68`):
```csharp
private System.Threading.SemaphoreSlim restartSemaphore;

public OpticSeqExecutor(...)
{
    restartSemaphore = new System.Threading.SemaphoreSlim(0, 1);
    // ...
}
```

**ë¬¸ì œì **:
- `SemaphoreSlim`ì€ `IDisposable` â†’ **ì¢…ë£Œ ì‹œ ëª…ì‹œì ìœ¼ë¡œ Dispose í•„ìš”**
- `WaitAsync` ëŒ€ê¸° ì¤‘ í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ â†’ **ë°ë“œë½ ê°€ëŠ¥ì„±**

---

### 4. **DLL ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ë¶€ì¡±**

**í˜„ì¬ ì½”ë“œ ë¶„ì„** (`App.xaml.cs:44-63`):
```csharp
protected override void OnExit(ExitEventArgs e)
{
    ErrorLogger.Dispose();
    MonitorLogService.Instance.Dispose();
    base.OnExit(e);
}
```

**ë¬¸ì œì **:
- `DllManager.Dispose()` í˜¸ì¶œ ì—†ìŒ
- **ì¥ë¹„ í¬íŠ¸ ì—°ê²° í•´ì œ í•¨ìˆ˜(`pg_off`, `meas_off`) ì—†ìŒ** â†’ í¬íŠ¸ ë¦¬ì†ŒìŠ¤ê°€ OS ë ˆë²¨ì—ì„œ ì ìœ  ìƒíƒœ ìœ ì§€

---

### 5. **ë¹„ë™ê¸° ì‘ì—… ì™„ë£Œ ëŒ€ê¸° ë¶€ì¡±**

**í˜„ì¬ ì½”ë“œ ë¶„ì„** (`OpticSeqExecutor.cs:151-152`):
```csharp
isTestStarted = true;
Task.Run(() => StartTestAsync());  // âŒ Fire and Forget
```

**ë¬¸ì œì **:
- `Task.Run`ìœ¼ë¡œ ì‹œì‘í•œ ë¹„ë™ê¸° ì‘ì—…ì„ ì¶”ì í•˜ì§€ ì•ŠìŒ
- í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ **ì‹¤í–‰ ì¤‘ì¸ Taskê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ì§€ ì•ŠìŒ**
- íŠ¹íˆ `RESTART` ëŒ€ê¸° ì¤‘(`restartSemaphore.WaitAsync`)ì¸ ê²½ìš° â†’ **ë¬´í•œ ëŒ€ê¸° ê°€ëŠ¥**

---

### 6. **ìš´ì˜ í”„ë¡œí† ì½œ ëŒ€ê¸° ë£¨í”„**

**í˜„ì¬ ì½”ë“œ ë¶„ì„** (`OpticSeqExecutor.cs:251-277`):
```csharp
// RESTART ëª…ë ¹ì´ ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸° (íƒ€ì„ì•„ì›ƒ: 10ë¶„)
int timeoutSeconds = int.Parse(GlobalDataManager.GetValue("Settings", "RESTART_TIMEOUT_SEC", "600"));
var cts = new System.Threading.CancellationTokenSource(TimeSpan.FromSeconds(timeoutSeconds));

try
{
    await restartSemaphore.WaitAsync(cts.Token);
    // ...
}
catch (OperationCanceledException)
{
    // íƒ€ì„ì•„ì›ƒ ë°œìƒ
    return;
}
```

**ë¬¸ì œì **:
- í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ì´ ëŒ€ê¸° ë£¨í”„ë¥¼ **ì¤‘ë‹¨í•  ë°©ë²•ì´ ì—†ìŒ**
- `CancellationToken`ì´ ì™¸ë¶€ì—ì„œ ì·¨ì†Œë˜ì§€ ì•Šìœ¼ë©´ â†’ **ìµœëŒ€ 10ë¶„ ëŒ€ê¸°**

---

## ğŸ› ï¸ ì ê²€ ë° ì¬í˜„ ë°©ë²•

### 1. ì‘ì—… ê´€ë¦¬ì ì ê²€

#### í”„ë¡œì„¸ìŠ¤ í™•ì¸
```
ì‘ì—… ê´€ë¦¬ì â†’ ì„¸ë¶€ ì •ë³´ íƒ­ â†’ OptiX.exe ê²€ìƒ‰
```
- Exe ì¢…ë£Œ í›„ í”„ë¡œì„¸ìŠ¤ê°€ ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸
- CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸ (0%ë©´ ì •ìƒ, ì ìœ  ì¤‘ì´ë©´ ì‘ì—… ì‹¤í–‰ ì¤‘)

#### í•¸ë“¤ í™•ì¸ (ê³ ê¸‰)
```powershell
# Sysinternals Handle.exe ì‚¬ìš©
handle.exe -p OptiX.exe
```
- íŒŒì¼ í•¸ë“¤, í¬íŠ¸ í•¸ë“¤, ìŠ¤ë ˆë“œ í•¸ë“¤ í™•ì¸

---

### 2. ë„¤íŠ¸ì›Œí¬ í¬íŠ¸ ì ê²€

#### PowerShell ëª…ë ¹ì–´
```powershell
# TCP í¬íŠ¸ 7777 ì ìœ  í™•ì¸
netstat -ano | findstr :7777

# PIDë¡œ í”„ë¡œì„¸ìŠ¤ í™•ì¸
tasklist | findstr <PID>
```

**ì˜ˆìƒ ê²°ê³¼**:
- ì •ìƒ ì¢…ë£Œ ì‹œ: í¬íŠ¸ 7777ì´ `LISTENING` ìƒíƒœê°€ ì•„ë‹˜
- ë¬¸ì œ ë°œìƒ ì‹œ: í¬íŠ¸ê°€ `ESTABLISHED` ë˜ëŠ” `TIME_WAIT` ìƒíƒœë¡œ ë‚¨ìŒ

---

### 3. ìŠ¤ë ˆë“œ ë¤í”„ ë¶„ì„

#### Visual Studio ë””ë²„ê±° ì‚¬ìš©
```
1. Exe ì‹¤í–‰ â†’ ì¢…ë£Œ ë²„íŠ¼ í´ë¦­
2. í”„ë¡œì„¸ìŠ¤ê°€ ì‚´ì•„ìˆëŠ” ìƒíƒœì—ì„œ VSì—ì„œ "ë””ë²„ê·¸ â†’ í”„ë¡œì„¸ìŠ¤ì— ì—°ê²°"
3. ë””ë²„ê·¸ â†’ ëª¨ë‘ ì¤‘ë‹¨ â†’ ë””ë²„ê·¸ â†’ ì°½ â†’ ìŠ¤ë ˆë“œ
```

**í™•ì¸ ì‚¬í•­**:
- `CommunicationServer.AcceptClientsAsync` ìŠ¤ë ˆë“œê°€ ì‚´ì•„ìˆëŠ”ì§€
- `OpticSeqExecutor.StartTestAsync` ìŠ¤ë ˆë“œê°€ ëŒ€ê¸° ì¤‘ì¸ì§€
- `Timer` ì½œë°± ìŠ¤ë ˆë“œê°€ ì‹¤í–‰ ì¤‘ì¸ì§€

---

### 4. ì¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### ì‹œë‚˜ë¦¬ì˜¤ A: í†µì‹  ì„œë²„ ì‹¤í–‰ ì¤‘ ì¢…ë£Œ
```
1. OptiX ì‹¤í–‰
2. Settings â†’ TCP/IP ì„œë²„ ì‹œì‘ (í¬íŠ¸ 7777)
3. Client ì—°ê²° (OptiX_Client ì‹¤í–‰)
4. Exe ì¢…ë£Œ (X ë²„íŠ¼ í´ë¦­)
5. ì‘ì—… ê´€ë¦¬ìì—ì„œ OptiX.exe í”„ë¡œì„¸ìŠ¤ í™•ì¸
6. ë‹¤ë¥¸ ë²„ì „ Exeë¥¼ ê°™ì€ í´ë”ì— ë³µì‚¬ ì‹œë„
```

**ì˜ˆìƒ ê²°ê³¼**: 
- âŒ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨ (í”„ë¡œì„¸ìŠ¤ ì”ì¡´)
- âœ… íŒŒì¼ ë³µì‚¬ ì„±ê³µ (ìˆ˜ì • í›„)

---

#### ì‹œë‚˜ë¦¬ì˜¤ B: OPTIC í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì¢…ë£Œ
```
1. OptiX ì‹¤í–‰
2. OPTIC í˜ì´ì§€ â†’ START ë²„íŠ¼ í´ë¦­
3. í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘ Exe ì¢…ë£Œ
4. ì¬ì‹¤í–‰ â†’ OPTIC Port Connect ì‹œë„
```

**ì˜ˆìƒ ê²°ê³¼**:
- âŒ í¬íŠ¸ ì ìœ  ì˜¤ë¥˜ ë°œìƒ
- âœ… í¬íŠ¸ ì •ìƒ ì—°ê²° (ìˆ˜ì • í›„)

---

#### ì‹œë‚˜ë¦¬ì˜¤ C: HVI ëª¨ë“œ RESTART ëŒ€ê¸° ì¤‘ ì¢…ë£Œ
```
1. OptiX ì‹¤í–‰ + Client ì—°ê²° (AUTO MODE)
2. HVI ëª¨ë“œ í™œì„±í™” (SEQUENCE 2ê°œ ì´ìƒ)
3. Clientì—ì„œ OPTIC_START ì „ì†¡
4. SEQUENCE1 ì™„ë£Œ â†’ RESTART ëŒ€ê¸° ì¤‘
5. Exe ì¢…ë£Œ ì‹œë„
```

**ì˜ˆìƒ ê²°ê³¼**:
- âŒ í”„ë¡œê·¸ë¨ì´ ì¦‰ì‹œ ì¢…ë£Œë˜ì§€ ì•ŠìŒ (Semaphore ëŒ€ê¸°)
- âœ… ì¦‰ì‹œ ì¢…ë£Œë¨ (CancellationToken ì¶”ê°€ í›„)

---

## ğŸ¯ í•´ê²° ë°©ì•ˆ ì„¤ê³„

### ì„¤ê³„ ì›ì¹™

#### 1. **ì¢…ë£Œ ìˆœì„œ (Shutdown Sequence)**
```
1. UI ìŠ¤ë ˆë“œ â†’ ì¢…ë£Œ ì‹ í˜¸ ë°œìƒ
2. í†µì‹  í”„ë¡œí† ì½œ ì¤‘ì§€ (RESTART ëŒ€ê¸° ì·¨ì†Œ)
3. ë¹„ë™ê¸° ì‘ì—…(Task) ì·¨ì†Œ ìš”ì²­ (CancellationToken)
4. ì¥ë¹„ ì „ì› ë„ê¸° (pg_off, meas_off)
5. í¬íŠ¸ ì—°ê²° í•´ì œ (Close Handles)
6. í†µì‹  ì„œë²„ ì¢…ë£Œ (TCP Listener Stop)
7. íƒ€ì´ë¨¸/ì„¸ë§ˆí¬ì–´ ì •ë¦¬ (Dispose)
8. ìŠ¤ë ˆë“œ ì¢…ë£Œ ëŒ€ê¸° (Join with Timeout)
9. í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
```

#### 2. **íƒ€ì„ì•„ì›ƒ ì „ëµ**
- ê° ë‹¨ê³„ë§ˆë‹¤ **ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì„¤ì •** (ì˜ˆ: 3ì´ˆ)
- íƒ€ì„ì•„ì›ƒ ì´ˆê³¼ ì‹œ **ê°•ì œ ì¢…ë£Œ** (ë¡œê·¸ ê¸°ë¡)

#### 3. **ì˜ˆì™¸ ì•ˆì „ì„±**
- ëª¨ë“  Dispose í˜¸ì¶œì„ `try-catch`ë¡œ ê°ì‹¸ê¸°
- í•œ ì»´í¬ë„ŒíŠ¸ ì •ë¦¬ ì‹¤íŒ¨ê°€ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì— ì˜í–¥ ì£¼ì§€ ì•Šë„ë¡

---

### ì»´í¬ë„ŒíŠ¸ë³„ ì¢…ë£Œ ì „ëµ

#### 1. **CommunicationServer**
```
- CancellationTokenìœ¼ë¡œ Accept/Handle ë£¨í”„ ì¤‘ë‹¨
- TcpListener.Stop() ì¦‰ì‹œ í˜¸ì¶œ (AcceptTcpClientAsync í•´ì œ)
- ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ SERVER_SHUTDOWN ì „ì†¡
- ëª¨ë“  TcpClient Close
- Task ì™„ë£Œ ëŒ€ê¸° (3ì´ˆ íƒ€ì„ì•„ì›ƒ)
```

#### 2. **OpticSeqExecutor**
```
- ì „ì—­ CancellationTokenSource ì¶”ê°€
- RESTART Semaphoreì— íƒ€ì„ì•„ì›ƒ + ì·¨ì†Œ í† í° ì „ë‹¬
- ì‹¤í–‰ ì¤‘ì¸ Task ì¶”ì  (private Task _runningTask)
- StopTest() ê°œì„ : CancellationToken ì·¨ì†Œ + Task ëŒ€ê¸°
```

#### 3. **Timer/Semaphore**
```
- MainWindow.OnClosedì—ì„œ ëª…ì‹œì  Dispose
- Dispose ì „ì— ì·¨ì†Œ í† í°ìœ¼ë¡œ ëŒ€ê¸° ì¤‘ì¸ ì‘ì—… í•´ì œ
```

#### 4. **Process DLL**
```
- pg_off(): PG í¬íŠ¸ ì—°ê²° í•´ì œ (í†µì‹  Close, ì „ì› OFF)
- meas_off(): ì¸¡ì •ê¸° í¬íŠ¸ ì—°ê²° í•´ì œ
- í¬íŠ¸ í•¸ë“¤ì„ ì „ì—­ ë³€ìˆ˜ë¡œ ê´€ë¦¬ (ì—°ê²° ì‹œ ì €ì¥, ì¢…ë£Œ ì‹œ í•´ì œ)
```

---

## ğŸ’» êµ¬í˜„ ê°€ì´ë“œ

### Phase 1: Process DLLì— ì¢…ë£Œ í•¨ìˆ˜ ì¶”ê°€

#### 1.1 ProcessTypes.hì— í¬íŠ¸ ìƒíƒœ êµ¬ì¡°ì²´ ì¶”ê°€

```cpp
// ProcessTypes.h
#pragma once

#pragma pack(push, 1)

#ifdef __cplusplus
extern "C" {
#endif

    // ê¸°ì¡´ êµ¬ì¡°ì²´ë“¤...

    // í¬íŠ¸ ì—°ê²° ìƒíƒœ ê´€ë¦¬ êµ¬ì¡°ì²´
    struct port_state {
        int pg_port;           // PG í¬íŠ¸ ë²ˆí˜¸ (-1: ì—°ê²° ì•ˆ ë¨)
        int meas_port;         // MEAS í¬íŠ¸ ë²ˆí˜¸ (-1: ì—°ê²° ì•ˆ ë¨)
        bool pg_connected;     // PG ì—°ê²° ìƒíƒœ
        bool meas_connected;   // MEAS ì—°ê²° ìƒíƒœ
    };

#ifdef __cplusplus
}
#endif

#pragma pack(pop)
```

---

#### 1.2 ProcessFunctions.hì— í•¨ìˆ˜ ì„ ì–¸ ì¶”ê°€

```cpp
// ProcessFunctions.h
#pragma once
#include "ProcessTypes.h"
#include <vector>

#ifdef __cplusplus
extern "C" {
#endif

    // ê¸°ì¡´ í•¨ìˆ˜ë“¤...

    // ===== ì¥ë¹„ ì¢…ë£Œ í•¨ìˆ˜ ì¶”ê°€ =====
    
    /// <summary>
    /// PG(Pattern Generator) í¬íŠ¸ ì—°ê²° í•´ì œ ë° ì „ì› ì°¨ë‹¨
    /// í˜¸ì¶œ ì‹œì : í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„
    /// </summary>
    __declspec(dllexport) bool pg_off();

    /// <summary>
    /// ì¸¡ì •ê¸°(Measurement Equipment) í¬íŠ¸ ì—°ê²° í•´ì œ
    /// í˜¸ì¶œ ì‹œì : í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„
    /// </summary>
    __declspec(dllexport) bool meas_off();

    /// <summary>
    /// ëª¨ë“  ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ (pg_off + meas_off)
    /// í˜¸ì¶œ ì‹œì : í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ (OnExit)
    /// </summary>
    __declspec(dllexport) bool cleanup_all_devices();

    /// <summary>
    /// í˜„ì¬ í¬íŠ¸ ì—°ê²° ìƒíƒœ ì¡°íšŒ
    /// </summary>
    __declspec(dllexport) void get_port_state(struct port_state* state);

#ifdef __cplusplus
}
#endif

#ifdef __cplusplus
// C++ ì „ìš© ë‚´ë¶€ í•¨ìˆ˜
void cal_lut(std::vector<LUT_Data> pattern_inf[3], struct output* out);
#endif
```

---

#### 1.3 ProcessFunctions.cppì— êµ¬í˜„ ì¶”ê°€

```cpp
// ProcessFunctions.cpp
#include "pch.h"
#include "ProcessFunctions.h"
#include "Process.h"
#include <random>
#include <cmath>
#include <ctime>
#include <iostream>

// ===== ì „ì—­ í¬íŠ¸ ìƒíƒœ ê´€ë¦¬ =====
namespace {
    bool g_mtp_initialized = false;
    bool g_ipvs_initialized = false;
    
    // í¬íŠ¸ ì—°ê²° ìƒíƒœ ì¶”ê°€
    port_state g_port_state = { -1, -1, false, false };
}

// ===== ê¸°ì¡´ í•¨ìˆ˜ë“¤ ìˆ˜ì • (í¬íŠ¸ ìƒíƒœ ê¸°ë¡) =====

__declspec(dllexport) bool PGTurn(int port) 
{
    if (port < 0)
        return false;
    
    // í¬íŠ¸ ì—°ê²° ì„±ê³µ ì‹œ ìƒíƒœ ì €ì¥
    g_port_state.pg_port = port;
    g_port_state.pg_connected = true;
    
    // TODO: ì‹¤ì œ í•˜ë“œì›¨ì–´ì™€ í†µì‹ í•˜ëŠ” ê²½ìš° ì—¬ê¸°ì— ì—°ê²° ì½”ë“œ ì¶”ê°€
    // ì˜ˆ: OpenSerialPort(port); ë˜ëŠ” InitializeUSB(port);
    
    return true;
}

__declspec(dllexport) bool Meas_Turn(int port) 
{
    if (port < 0)
        return false;
    
    // í¬íŠ¸ ì—°ê²° ì„±ê³µ ì‹œ ìƒíƒœ ì €ì¥
    g_port_state.meas_port = port;
    g_port_state.meas_connected = true;
    
    // TODO: ì‹¤ì œ í•˜ë“œì›¨ì–´ì™€ í†µì‹ í•˜ëŠ” ê²½ìš° ì—¬ê¸°ì— ì—°ê²° ì½”ë“œ ì¶”ê°€
    
    return true;
}

// ===== ìƒˆë¡œ ì¶”ê°€: ì¥ë¹„ ì¢…ë£Œ í•¨ìˆ˜ =====

/// <summary>
/// PG í¬íŠ¸ ì—°ê²° í•´ì œ ë° ì „ì› ì°¨ë‹¨
/// </summary>
__declspec(dllexport) bool pg_off()
{
    try
    {
        if (!g_port_state.pg_connected)
        {
            // ì´ë¯¸ ì—°ê²° í•´ì œëœ ìƒíƒœ
            return true;
        }

        // TODO: ì‹¤ì œ í•˜ë“œì›¨ì–´ ì „ì› ì°¨ë‹¨ ë¡œì§ ì¶”ê°€
        // ì˜ˆ:
        // if (g_pg_handle != nullptr) {
        //     SendCommand(g_pg_handle, "POWER_OFF");
        //     CloseSerialPort(g_pg_handle);
        //     g_pg_handle = nullptr;
        // }

        // í¬íŠ¸ ìƒíƒœ ì´ˆê¸°í™”
        g_port_state.pg_port = -1;
        g_port_state.pg_connected = false;

        // ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
        std::cout << "[Process.dll] PG í¬íŠ¸ ì—°ê²° í•´ì œ ì™„ë£Œ" << std::endl;

        return true;
    }
    catch (...)
    {
        // ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ ìƒíƒœëŠ” ì´ˆê¸°í™”
        g_port_state.pg_port = -1;
        g_port_state.pg_connected = false;
        return false;
    }
}

/// <summary>
/// ì¸¡ì •ê¸° í¬íŠ¸ ì—°ê²° í•´ì œ
/// </summary>
__declspec(dllexport) bool meas_off()
{
    try
    {
        if (!g_port_state.meas_connected)
        {
            return true;
        }

        // TODO: ì‹¤ì œ í•˜ë“œì›¨ì–´ ì—°ê²° í•´ì œ ë¡œì§ ì¶”ê°€
        // ì˜ˆ:
        // if (g_meas_handle != nullptr) {
        //     DisconnectMeasurementDevice(g_meas_handle);
        //     g_meas_handle = nullptr;
        // }

        g_port_state.meas_port = -1;
        g_port_state.meas_connected = false;

        std::cout << "[Process.dll] ì¸¡ì •ê¸° í¬íŠ¸ ì—°ê²° í•´ì œ ì™„ë£Œ" << std::endl;

        return true;
    }
    catch (...)
    {
        g_port_state.meas_port = -1;
        g_port_state.meas_connected = false;
        return false;
    }
}

/// <summary>
/// ëª¨ë“  ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ
/// </summary>
__declspec(dllexport) bool cleanup_all_devices()
{
    bool pg_result = pg_off();
    bool meas_result = meas_off();

    // ì´ˆê¸°í™” í”Œë˜ê·¸ë„ ë¦¬ì…‹
    g_mtp_initialized = false;
    g_ipvs_initialized = false;

    std::cout << "[Process.dll] ëª¨ë“  ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ ì™„ë£Œ (PG: " 
              << (pg_result ? "ì„±ê³µ" : "ì‹¤íŒ¨") 
              << ", MEAS: " 
              << (meas_result ? "ì„±ê³µ" : "ì‹¤íŒ¨") 
              << ")" << std::endl;

    return pg_result && meas_result;
}

/// <summary>
/// í˜„ì¬ í¬íŠ¸ ì—°ê²° ìƒíƒœ ì¡°íšŒ
/// </summary>
__declspec(dllexport) void get_port_state(struct port_state* state)
{
    if (state != nullptr)
    {
        *state = g_port_state;
    }
}

// ... ê¸°ì¡´ í•¨ìˆ˜ë“¤ (MTP_test, IPVS_test ë“±)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ ...
```

---

### Phase 2: C# DllManagerì— ì¢…ë£Œ í•¨ìˆ˜ ì—°ê²°

#### 2.1 DllManager.csì— P/Invoke ì„ ì–¸ ì¶”ê°€

```csharp
// DllManager.cs
// ... ê¸°ì¡´ ì½”ë“œ ...

#region DLL Function Declarations (P/Invoke)

// ... ê¸°ì¡´ í•¨ìˆ˜ë“¤ ...

// ===== ì¥ë¹„ ì¢…ë£Œ í•¨ìˆ˜ ì¶”ê°€ =====

/// <summary>
/// PG í¬íŠ¸ ì—°ê²° í•´ì œ ë° ì „ì› ì°¨ë‹¨
/// C++: bool pg_off()
/// </summary>
[DllImport(DLL_NAME, CallingConvention = CallingConvention.Cdecl,
           EntryPoint = "pg_off", ExactSpelling = true)]
[return: MarshalAs(UnmanagedType.Bool)]
public static extern bool pg_off();

/// <summary>
/// ì¸¡ì •ê¸° í¬íŠ¸ ì—°ê²° í•´ì œ
/// C++: bool meas_off()
/// </summary>
[DllImport(DLL_NAME, CallingConvention = CallingConvention.Cdecl,
           EntryPoint = "meas_off", ExactSpelling = true)]
[return: MarshalAs(UnmanagedType.Bool)]
public static extern bool meas_off();

/// <summary>
/// ëª¨ë“  ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ
/// C++: bool cleanup_all_devices()
/// </summary>
[DllImport(DLL_NAME, CallingConvention = CallingConvention.Cdecl,
           EntryPoint = "cleanup_all_devices", ExactSpelling = true)]
[return: MarshalAs(UnmanagedType.Bool)]
public static extern bool cleanup_all_devices();

#endregion
```

---

#### 2.2 DllManager.Dispose() ê°•í™”

```csharp
// DllManager.cs (ê¸°ì¡´ Dispose ë©”ì„œë“œ ìˆ˜ì •)

/// <summary>
/// DLL ì •ë¦¬ (í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ í˜¸ì¶œ)
/// ëª¨ë“  ì¥ë¹„ ë¦¬ì†ŒìŠ¤ë¥¼ ì•ˆì „í•˜ê²Œ í•´ì œí•©ë‹ˆë‹¤.
/// </summary>
public static void Dispose()
{
    lock (_initLock)
    {
        try
        {
            Debug.WriteLine("[DllManager] ========== DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì‹œì‘ ==========");
            
            // 1. ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ (í¬íŠ¸ ì—°ê²° ëŠê¸°)
            if (_isInitialized)
            {
                try
                {
                    Debug.WriteLine("[DllManager] ì¥ë¹„ í¬íŠ¸ ì—°ê²° í•´ì œ ì‹œë„...");
                    bool result = cleanup_all_devices();
                    Debug.WriteLine($"[DllManager] ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ {(result ? "ì„±ê³µ" : "ì‹¤íŒ¨")}");
                    ErrorLogger.Log($"ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ: {(result ? "ì„±ê³µ" : "ì‹¤íŒ¨")}", 
                                    result ? ErrorLogger.LogLevel.INFO : ErrorLogger.LogLevel.WARNING);
                }
                catch (Exception ex)
                {
                    Debug.WriteLine($"[DllManager] ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ ì¤‘ ì˜ˆì™¸: {ex.Message}");
                    ErrorLogger.LogException(ex, "ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ ì‹¤íŒ¨ (DLL í•¨ìˆ˜ í˜¸ì¶œ ì˜ˆì™¸)");
                }
            }

            // 2. ì´ˆê¸°í™” ìƒíƒœ ë¦¬ì…‹
            _isInitialized = false;
            _isDllDirectorySet = false;
            _currentDllDirectory = "";
            
            Debug.WriteLine("[DllManager] ========== DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì™„ë£Œ ==========");
            ErrorLogger.Log("DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì™„ë£Œ", ErrorLogger.LogLevel.INFO);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[DllManager] í•´ì œ ì˜¤ë¥˜: {ex.Message}");
            ErrorLogger.LogException(ex, "DLL í•´ì œ ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }
}
```

---

### Phase 3: MainWindow ì¢…ë£Œ ì²˜ë¦¬ ê°•í™”

#### 3.1 ì „ì—­ CancellationToken ì¶”ê°€

```csharp
// MainWindow.xaml.cs

public partial class MainWindow : Window
{
    // ... ê¸°ì¡´ í•„ë“œë“¤ ...
    
    // ===== ì¢…ë£Œ ì²˜ë¦¬ìš© CancellationToken ì¶”ê°€ =====
    private CancellationTokenSource shutdownCancellationTokenSource;
    
    public MainWindow()
    {
        InitializeComponent();
        
        // ì¢…ë£Œ í† í° ì´ˆê¸°í™”
        shutdownCancellationTokenSource = new CancellationTokenSource();
        
        LoadSettingsFromIni();
        InitializeCommunicationServer();
        
        // ... ê¸°ì¡´ ì½”ë“œ ...
    }
    
    // ... ê¸°ì¡´ ë©”ì„œë“œë“¤ ...
```

---

#### 3.2 OnClosed ë©”ì„œë“œ ê°œì„ 

```csharp
// MainWindow.xaml.cs (ê¸°ì¡´ OnClosed ë©”ì„œë“œ ì „ì²´ êµì²´)

protected override void OnClosed(EventArgs e)
{
    try
    {
        Debug.WriteLine("========== MainWindow ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ==========");
        ErrorLogger.Log("í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œì‘", ErrorLogger.LogLevel.INFO);

        // ===== 1ë‹¨ê³„: ì „ì—­ ì·¨ì†Œ í† í° ë°œìƒ (ëª¨ë“  ë¹„ë™ê¸° ì‘ì—… ì¤‘ë‹¨ ì‹ í˜¸) =====
        Debug.WriteLine("[Shutdown] 1ë‹¨ê³„: ì „ì—­ ì·¨ì†Œ í† í° ë°œìƒ");
        shutdownCancellationTokenSource?.Cancel();

        // ===== 2ë‹¨ê³„: Timer ì •ë¦¬ =====
        Debug.WriteLine("[Shutdown] 2ë‹¨ê³„: Timer ì •ë¦¬");
        try
        {
            opticTestTimer?.Dispose();
            opticTestTimer = null;
            Debug.WriteLine("[Shutdown] opticTestTimer ì •ë¦¬ ì™„ë£Œ");
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[Shutdown] Timer ì •ë¦¬ ì‹¤íŒ¨: {ex.Message}");
        }

        // ===== 3ë‹¨ê³„: í†µì‹  ì„œë²„ ì¢…ë£Œ (í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ëŠê¸°) =====
        Debug.WriteLine("[Shutdown] 3ë‹¨ê³„: í†µì‹  ì„œë²„ ì¢…ë£Œ");
        if (communicationServer != null)
        {
            try
            {
                // 3-1. í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¢…ë£Œ ë©”ì‹œì§€ ì „ì†¡ (1ì´ˆ íƒ€ì„ì•„ì›ƒ)
                var sendShutdownTask = communicationServer.SendMessageToAllClientsAsync("SERVER_SHUTDOWN");
                if (!sendShutdownTask.Wait(TimeSpan.FromSeconds(1)))
                {
                    Debug.WriteLine("[Shutdown] ì¢…ë£Œ ë©”ì‹œì§€ ì „ì†¡ íƒ€ì„ì•„ì›ƒ (1ì´ˆ ì´ˆê³¼)");
                }

                // 3-2. ì„œë²„ ì¤‘ì§€ (3ì´ˆ íƒ€ì„ì•„ì›ƒ)
                var stopServerTask = communicationServer.StopServerAsync();
                if (!stopServerTask.Wait(TimeSpan.FromSeconds(3)))
                {
                    Debug.WriteLine("[Shutdown] ì„œë²„ ì¤‘ì§€ íƒ€ì„ì•„ì›ƒ (3ì´ˆ ì´ˆê³¼) - ê°•ì œ ì¢…ë£Œ");
                    ErrorLogger.Log("í†µì‹  ì„œë²„ ì¢…ë£Œ íƒ€ì„ì•„ì›ƒ (ê°•ì œ ì¢…ë£Œë¨)", ErrorLogger.LogLevel.WARNING);
                }
                else
                {
                    Debug.WriteLine("[Shutdown] í†µì‹  ì„œë²„ ì •ìƒ ì¢…ë£Œ");
                }

                // 3-3. Dispose
                communicationServer.Dispose();
                communicationServer = null;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"[Shutdown] í†µì‹  ì„œë²„ ì •ë¦¬ ì¤‘ ì˜ˆì™¸: {ex.Message}");
                ErrorLogger.LogException(ex, "í†µì‹  ì„œë²„ ì •ë¦¬ ì‹¤íŒ¨");
            }
        }

        // ===== 4ë‹¨ê³„: OpticSeqExecutor ì‘ì—… ì¤‘ë‹¨ (í˜ì´ì§€ê°€ ìˆëŠ” ê²½ìš°) =====
        Debug.WriteLine("[Shutdown] 4ë‹¨ê³„: ì‹¤í–‰ ì¤‘ì¸ í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨");
        try
        {
            var opticPage = pageNavigationManager?.GetCurrentPage() as OpticPage;
            if (opticPage != null)
            {
                var viewModel = opticPage.DataContext as OptiX.OPTIC.OpticPageViewModel;
                if (viewModel != null)
                {
                    viewModel.StopAllTests(); // ìƒˆë¡œ ì¶”ê°€í•  ë©”ì„œë“œ
                }
            }
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[Shutdown] í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨ ì‹¤íŒ¨: {ex.Message}");
        }

        // ===== 5ë‹¨ê³„: DLL ë¦¬ì†ŒìŠ¤ í•´ì œ (ì¥ë¹„ í¬íŠ¸ ì—°ê²° ëŠê¸°) =====
        Debug.WriteLine("[Shutdown] 5ë‹¨ê³„: DLL ë¦¬ì†ŒìŠ¤ í•´ì œ");
        try
        {
            DllManager.Dispose();
            Debug.WriteLine("[Shutdown] DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì™„ë£Œ");
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[Shutdown] DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì‹¤íŒ¨: {ex.Message}");
            ErrorLogger.LogException(ex, "DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì‹¤íŒ¨");
        }

        // ===== 6ë‹¨ê³„: ì–¸ì–´ ì´ë²¤íŠ¸ êµ¬ë… í•´ì œ =====
        Debug.WriteLine("[Shutdown] 6ë‹¨ê³„: ì´ë²¤íŠ¸ êµ¬ë… í•´ì œ");
        LanguageManager.LanguageChanged -= OnLanguageChanged;

        // ===== 7ë‹¨ê³„: ë¡œê±° ì •ë¦¬ (App.OnExitì—ì„œë„ ì‹¤í–‰ë˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ì¤‘ë³µ í˜¸ì¶œ) =====
        Debug.WriteLine("[Shutdown] 7ë‹¨ê³„: ë¡œê±° ì •ë¦¬");
        // App.OnExitì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìƒëµ ê°€ëŠ¥

        Debug.WriteLine("========== MainWindow ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ==========");
    }
    catch (Exception ex)
    {
        Debug.WriteLine($"[Shutdown] ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {ex.Message}");
        ErrorLogger.LogException(ex, "MainWindow ì¢…ë£Œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸");
    }
    finally
    {
        // ìµœì¢… ì •ë¦¬
        shutdownCancellationTokenSource?.Dispose();
        base.OnClosed(e);
    }
}
```

---

### Phase 4: CommunicationServer ì¢…ë£Œ ê°œì„ 

#### 4.1 Dispose ë©”ì„œë“œ ì¶”ê°€

```csharp
// CommunicationServer.cs

public class CommunicationServer : IDisposable
{
    // ... ê¸°ì¡´ í•„ë“œë“¤ ...
    
    private bool disposed = false;

    // ... ê¸°ì¡´ ë©”ì„œë“œë“¤ ...

    /// <summary>
    /// ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    /// </summary>
    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    protected virtual void Dispose(bool disposing)
    {
        if (!disposed)
        {
            if (disposing)
            {
                try
                {
                    // CancellationTokenSource ì •ë¦¬
                    cancellationTokenSource?.Cancel();
                    cancellationTokenSource?.Dispose();
                    cancellationTokenSource = null;

                    // TcpListener ì •ë¦¬
                    tcpListener?.Stop();
                    tcpListener = null;

                    // ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬
                    lock (clientsLock)
                    {
                        foreach (var client in connectedClients.ToList())
                        {
                            try
                            {
                                client?.Close();
                                client?.Dispose();
                            }
                            catch { }
                        }
                        connectedClients.Clear();
                    }

                    LogMessage?.Invoke(this, "ğŸ§¹ CommunicationServer ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ");
                }
                catch (Exception ex)
                {
                    LogMessage?.Invoke(this, $"âŒ CommunicationServer ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: {ex.Message}");
                }
            }

            disposed = true;
        }
    }
}
```

---

#### 4.2 StopServerAsync ê°œì„ 

```csharp
// CommunicationServer.cs (ê¸°ì¡´ StopServerAsync ë©”ì„œë“œ ê°œì„ )

/// <summary>
/// TCP ì„œë²„ ì¤‘ì§€ (ê°œì„  ë²„ì „)
/// </summary>
public async Task StopServerAsync()
{
    try
    {
        if (!isRunning)
        {
            LogMessage?.Invoke(this, "âš ï¸ ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        LogMessage?.Invoke(this, "ğŸ›‘ TCP ì„œë²„ ì¤‘ì§€ ì‹œì‘...");

        // 1. ì·¨ì†Œ í† í° ì‹ í˜¸ (Accept/Handle ë£¨í”„ ì¤‘ë‹¨)
        cancellationTokenSource?.Cancel();

        // 2. TCP ë¦¬ìŠ¤ë„ˆ ì¤‘ì§€ (AcceptTcpClientAsync ì¦‰ì‹œ í•´ì œ)
        tcpListener?.Stop();

        // 3. ì—°ê²°ëœ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œ
        List<Task> clientCloseTasks = new List<Task>();
        lock (clientsLock)
        {
            foreach (var client in connectedClients.ToList())
            {
                clientCloseTasks.Add(Task.Run(() =>
                {
                    try
                    {
                        client?.GetStream()?.Close();
                        client?.Close();
                    }
                    catch { }
                }));
            }
            connectedClients.Clear();
        }

        // 4. ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œ ëŒ€ê¸° (ìµœëŒ€ 2ì´ˆ)
        var allClientsClosedTask = Task.WhenAll(clientCloseTasks);
        if (await Task.WhenAny(allClientsClosedTask, Task.Delay(2000)) == allClientsClosedTask)
        {
            LogMessage?.Invoke(this, "âœ… ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì •ìƒ ì¢…ë£Œ");
        }
        else
        {
            LogMessage?.Invoke(this, "âš ï¸ ì¼ë¶€ í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œ íƒ€ì„ì•„ì›ƒ");
        }

        isRunning = false;
        
        LogMessage?.Invoke(this, "ğŸ›‘ TCP ì„œë²„ ì¤‘ì§€ ì™„ë£Œ");
        CommunicationLogger.WriteLog($"ğŸ›‘ [SERVER_STOP] ì„œë²„ ì¤‘ì§€ ì™„ë£Œ");
        
        ConnectionStatusChanged?.Invoke(this, false);
    }
    catch (Exception ex)
    {
        LogMessage?.Invoke(this, $"âŒ ì„œë²„ ì¤‘ì§€ ì‹¤íŒ¨: {ex.Message}");
        ErrorLogger.LogException(ex, "CommunicationServer.StopServerAsync ì‹¤íŒ¨");
    }
}
```

---

### Phase 5: OpticSeqExecutor ì¢…ë£Œ ì²˜ë¦¬ ì¶”ê°€

#### 5.1 CancellationToken ì¶”ê°€

```csharp
// OpticSeqExecutor.cs

public class OpticSeqExecutor
{
    // ... ê¸°ì¡´ í•„ë“œë“¤ ...
    
    // ===== ì¢…ë£Œ ì²˜ë¦¬ìš© CancellationToken ì¶”ê°€ =====
    private CancellationTokenSource testCancellationTokenSource;
    private Task runningTestTask;
    
    public OpticSeqExecutor(...)
    {
        // ... ê¸°ì¡´ ì´ˆê¸°í™” ...
        
        testCancellationTokenSource = new CancellationTokenSource();
    }
    
    // ... ê¸°ì¡´ ë©”ì„œë“œë“¤ ...
```

---

#### 5.2 StartTest ë©”ì„œë“œ ìˆ˜ì • (Task ì¶”ì )

```csharp
// OpticSeqExecutor.cs (ê¸°ì¡´ StartTest ë©”ì„œë“œ ìˆ˜ì •)

public void StartTest()
{
    if (isTestStarted)
    {
        Debug.WriteLine("[OpticSeqExecutor] ì´ë¯¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ - ì¤‘ë³µ ì‹¤í–‰ ë¬´ì‹œ");
        return;
    }
    
    isTestStarted = true;
    
    // CancellationToken ë¦¬ì…‹
    testCancellationTokenSource?.Dispose();
    testCancellationTokenSource = new CancellationTokenSource();
    
    // Task ì¶”ì  (ì¢…ë£Œ ì‹œ ëŒ€ê¸°ìš©)
    runningTestTask = Task.Run(() => StartTestAsync(testCancellationTokenSource.Token));
}
```

---

#### 5.3 StartTestAsync ìˆ˜ì • (CancellationToken ì „ë‹¬)

```csharp
// OpticSeqExecutor.cs (ê¸°ì¡´ StartTestAsync ë©”ì„œë“œ ìˆ˜ì •)

private async Task StartTestAsync(CancellationToken cancellationToken)
{
    try
    {
        ErrorLogger.Log("=== OPTIC í…ŒìŠ¤íŠ¸ ì‹œì‘ ===", ErrorLogger.LogLevel.INFO);

        // DLL ì´ˆê¸°í™” í™•ì¸
        if (!DllManager.IsInitialized)
        {
            // ... ê¸°ì¡´ ì½”ë“œ ...
            return;
        }

        // ===== ì·¨ì†Œ í† í° ì²´í¬ ì¶”ê°€ =====
        if (cancellationToken.IsCancellationRequested)
        {
            ErrorLogger.Log("í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ ì·¨ì†Œë¨", ErrorLogger.LogLevel.INFO);
            return;
        }

        // ... ê¸°ì¡´ Zone/Sequence ì´ˆê¸°í™” ì½”ë“œ ...

        // SEQUENCEë³„ë¡œ ìˆœì°¨ ì‹¤í–‰
        for (int seqIndex = 0; seqIndex < sequencesToRun; seqIndex++)
        {
            // ===== ì·¨ì†Œ í† í° ì²´í¬ =====
            if (cancellationToken.IsCancellationRequested)
            {
                ErrorLogger.Log($"SEQUENCE{seqIndex + 1} ì‹¤í–‰ ì¤‘ ì·¨ì†Œë¨", ErrorLogger.LogLevel.INFO);
                return;
            }

            var currentSequence = sequenceGroups[seqIndex];
            ErrorLogger.Log($"=== SEQUENCE{seqIndex + 1} ì‹œì‘ ===", ErrorLogger.LogLevel.INFO);
            
            // Zoneë³„ë¡œ ë³‘ë ¬ ì‹¤í–‰
            var tasks = new List<Task>();
            for (int zoneId = 1; zoneId <= zoneCount; zoneId++)
            {
                int currentZoneId = zoneId;
                int currentSeqIndex = seqIndex;
                tasks.Add(Task.Run(() => ExecuteSeqForZoneAsync(currentZoneId, currentSequence, isHviMode, currentSeqIndex, cancellationToken), cancellationToken));
            }

            // ëª¨ë“  Zone ì™„ë£Œ ëŒ€ê¸°
            await Task.WhenAll(tasks);
            
            // ... RESTART ëŒ€ê¸° ì½”ë“œ (ìˆ˜ì • í•„ìš”) ...
            
            if (isAutoMode && isHviMode && currentSequence.Count > 0)
            {
                string lastStep = currentSequence[currentSequence.Count - 1];
                if (lastStep.ToUpper().Contains("SEND_TO_CLIENT"))
                {
                    await SendSequenceCompleteToClient(seqIndex + 1, sequencesToRun);
                    
                    if (seqIndex < sequencesToRun - 1)
                    {
                        ErrorLogger.Log($"â¸ï¸ SEQUENCE{seqIndex + 1} ì™„ë£Œ - RESTART ëª…ë ¹ ëŒ€ê¸° ì¤‘...", ErrorLogger.LogLevel.INFO);
                        MonitorLogService.Instance.Log(0, $"WAIT RESTART (SEQUENCE{seqIndex + 1} â†’ SEQUENCE{seqIndex + 2})");
                        
                        int timeoutSeconds = int.Parse(GlobalDataManager.GetValue("Settings", "RESTART_TIMEOUT_SEC", "600"));
                        
                        // ===== CancellationToken ì—°ê²° (Linked Token) =====
                        var linkedCts = CancellationTokenSource.CreateLinkedTokenSource(
                            cancellationToken,
                            new CancellationTokenSource(TimeSpan.FromSeconds(timeoutSeconds)).Token
                        );
                        
                        try
                        {
                            await restartSemaphore.WaitAsync(linkedCts.Token);
                            ErrorLogger.Log($"â–¶ï¸ RESTART ëª…ë ¹ ìˆ˜ì‹  ì™„ë£Œ", ErrorLogger.LogLevel.INFO);
                        }
                        catch (OperationCanceledException)
                        {
                            if (cancellationToken.IsCancellationRequested)
                            {
                                // í”„ë¡œê·¸ë¨ ì¢…ë£Œë¡œ ì¸í•œ ì·¨ì†Œ
                                ErrorLogger.Log("í”„ë¡œê·¸ë¨ ì¢…ë£Œë¡œ RESTART ëŒ€ê¸° ì·¨ì†Œë¨", ErrorLogger.LogLevel.INFO);
                                return;
                            }
                            else
                            {
                                // íƒ€ì„ì•„ì›ƒ
                                ErrorLogger.Log($"â±ï¸ RESTART ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ ({timeoutSeconds}ì´ˆ)", ErrorLogger.LogLevel.WARNING);
                                return;
                            }
                        }
                        finally
                        {
                            linkedCts.Dispose();
                        }
                    }
                }
            }
        }
        
        // ... ê¸°ì¡´ ì¢…ë£Œ ì½”ë“œ ...
    }
    finally
    {
        isTestStarted = false;
        viewModel?.ClearExternalInputData();
    }
}
```

---

#### 5.4 StopAllTests ë©”ì„œë“œ ì¶”ê°€

```csharp
// OpticSeqExecutor.cs (ìƒˆ ë©”ì„œë“œ ì¶”ê°€)

/// <summary>
/// ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨ (í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ í˜¸ì¶œ)
/// </summary>
public void StopAllTests()
{
    try
    {
        ErrorLogger.Log("ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨ ìš”ì²­", ErrorLogger.LogLevel.INFO);
        
        // 1. CancellationToken ì·¨ì†Œ
        testCancellationTokenSource?.Cancel();
        
        // 2. Semaphore í•´ì œ (RESTART ëŒ€ê¸° ì¤‘ì¸ ê²½ìš°)
        try
        {
            if (restartSemaphore.CurrentCount == 0)
            {
                restartSemaphore.Release();
            }
        }
        catch { }
        
        // 3. ì‹¤í–‰ ì¤‘ì¸ Task ëŒ€ê¸° (ìµœëŒ€ 3ì´ˆ)
        if (runningTestTask != null && !runningTestTask.IsCompleted)
        {
            if (runningTestTask.Wait(TimeSpan.FromSeconds(3)))
            {
                ErrorLogger.Log("í…ŒìŠ¤íŠ¸ ì •ìƒ ì¢…ë£Œë¨", ErrorLogger.LogLevel.INFO);
            }
            else
            {
                ErrorLogger.Log("í…ŒìŠ¤íŠ¸ ì¢…ë£Œ íƒ€ì„ì•„ì›ƒ (ê°•ì œ ì¢…ë£Œ)", ErrorLogger.LogLevel.WARNING);
            }
        }
        
        // 4. ìƒíƒœ ë¦¬ì…‹
        isTestStarted = false;
    }
    catch (Exception ex)
    {
        ErrorLogger.LogException(ex, "í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨ ì¤‘ ì˜¤ë¥˜");
    }
}

/// <summary>
/// ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (Dispose íŒ¨í„´)
/// </summary>
public void Dispose()
{
    try
    {
        StopAllTests();
        
        testCancellationTokenSource?.Dispose();
        restartSemaphore?.Dispose();
        
        // CommunicationServer ì´ë²¤íŠ¸ êµ¬ë… í•´ì œ
        if (communicationServer != null)
        {
            communicationServer.OpticRestartRequested -= OnOpticRestartRequested;
        }
    }
    catch (Exception ex)
    {
        ErrorLogger.LogException(ex, "OpticSeqExecutor.Dispose ì¤‘ ì˜¤ë¥˜");
    }
}
```

---

#### 5.5 OpticPageViewModelì— StopAllTests ì—°ê²°

```csharp
// OpticPageViewModel.cs

public class OpticPageViewModel : INotifyPropertyChanged
{
    // ... ê¸°ì¡´ í•„ë“œë“¤ ...
    
    private OpticSeqExecutor seqExecutor;
    
    // ... ê¸°ì¡´ ë©”ì„œë“œë“¤ ...
    
    /// <summary>
    /// ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨ (í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ í˜¸ì¶œ)
    /// </summary>
    public void StopAllTests()
    {
        seqExecutor?.StopAllTests();
    }
}
```

---

### Phase 6: App.xaml.cs OnExit ê°œì„ 

```csharp
// App.xaml.cs (ê¸°ì¡´ OnExit ë©”ì„œë“œ ìˆ˜ì •)

protected override void OnExit(ExitEventArgs e)
{
    try
    {
        Debug.WriteLine("========== Application ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ==========");
        
        // ===== 1. DLL ë¦¬ì†ŒìŠ¤ í•´ì œ (MainWindow.OnClosedì—ì„œë„ í˜¸ì¶œë˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ì¤‘ë³µ í˜¸ì¶œ) =====
        try
        {
            Debug.WriteLine("[App.OnExit] DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì‹œì‘...");
            DllManager.Dispose();
            Debug.WriteLine("[App.OnExit] DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì™„ë£Œ");
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[App.OnExit] DLL ë¦¬ì†ŒìŠ¤ í•´ì œ ì‹¤íŒ¨: {ex.Message}");
        }
        
        // ===== 2. MonitorLogService ì¢…ë£Œ =====
        try
        {
            Debug.WriteLine("[App.OnExit] MonitorLogService ì¢…ë£Œ ì‹œì‘...");
            MonitorLogService.Instance.Dispose();
            Debug.WriteLine("[App.OnExit] MonitorLogService ì¢…ë£Œ ì™„ë£Œ");
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[App.OnExit] MonitorLogService ì¢…ë£Œ ì‹¤íŒ¨: {ex.Message}");
        }
        
        // ===== 3. ErrorLogger ì¢…ë£Œ (ë‚¨ì€ ë¡œê·¸ë¥¼ íŒŒì¼ì— í”ŒëŸ¬ì‹œ) =====
        try
        {
            Debug.WriteLine("[App.OnExit] ErrorLogger ì¢…ë£Œ ì‹œì‘...");
            ErrorLogger.Dispose();
            Debug.WriteLine("[App.OnExit] ErrorLogger ì¢…ë£Œ ì™„ë£Œ");
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[App.OnExit] ErrorLogger ì¢…ë£Œ ì‹¤íŒ¨: {ex.Message}");
        }
        
        Debug.WriteLine("========== Application ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ==========");
    }
    catch (Exception ex)
    {
        Debug.WriteLine($"[App.OnExit] ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {ex.Message}");
    }
    finally
    {
        // ì§§ì€ ëŒ€ê¸° (ë¡œê·¸ í”ŒëŸ¬ì‹œ ì‹œê°„ í™•ë³´)
        System.Threading.Thread.Sleep(100);
        base.OnExit(e);
    }
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### í…ŒìŠ¤íŠ¸ 1: ì •ìƒ ì¢…ë£Œ ì‹œë‚˜ë¦¬ì˜¤

#### ì ˆì°¨
```
1. OptiX ì‹¤í–‰
2. OPTIC í˜ì´ì§€ë¡œ ì´ë™
3. START ë²„íŠ¼ í´ë¦­ â†’ í…ŒìŠ¤íŠ¸ ì§„í–‰
4. í…ŒìŠ¤íŠ¸ ì™„ë£Œ ëŒ€ê¸°
5. X ë²„íŠ¼ìœ¼ë¡œ í”„ë¡œê·¸ë¨ ì¢…ë£Œ
6. ì‘ì—… ê´€ë¦¬ì í™•ì¸
```

#### ì˜ˆìƒ ê²°ê³¼
- âœ… í”„ë¡œì„¸ìŠ¤ê°€ ì¦‰ì‹œ ì¢…ë£Œë¨ (1ì´ˆ ì´ë‚´)
- âœ… ì‘ì—… ê´€ë¦¬ìì— OptiX.exe ì—†ìŒ
- âœ… í¬íŠ¸ 7777ì´ `netstat`ì—ì„œ ë³´ì´ì§€ ì•ŠìŒ
- âœ… ë¡œê·¸ íŒŒì¼ì— "ëª¨ë“  ì¥ë¹„ ë¦¬ì†ŒìŠ¤ í•´ì œ ì™„ë£Œ" ê¸°ë¡ë¨

---

### í…ŒìŠ¤íŠ¸ 2: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ê°•ì œ ì¢…ë£Œ

#### ì ˆì°¨
```
1. OptiX ì‹¤í–‰
2. OPTIC í…ŒìŠ¤íŠ¸ ì‹œì‘
3. ì§„í–‰ ì¤‘ (30% ì™„ë£Œ ì‹œì ) X ë²„íŠ¼ í´ë¦­
4. 3ì´ˆ ëŒ€ê¸°
5. ì‘ì—… ê´€ë¦¬ì í™•ì¸
```

#### ì˜ˆìƒ ê²°ê³¼
- âœ… í”„ë¡œê·¸ë¨ì´ 3ì´ˆ ì´ë‚´ì— ì¢…ë£Œë¨
- âœ… CancellationTokenìœ¼ë¡œ ë¹„ë™ê¸° ì‘ì—… ì¤‘ë‹¨ë¨
- âœ… ë¡œê·¸ì— "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì·¨ì†Œë¨" ê¸°ë¡

---

### í…ŒìŠ¤íŠ¸ 3: RESTART ëŒ€ê¸° ì¤‘ ì¢…ë£Œ

#### ì ˆì°¨
```
1. OptiX ì‹¤í–‰ + Client ì—°ê²°
2. HVI ëª¨ë“œ í™œì„±í™” (SEQUENCE 2ê°œ)
3. OPTIC_START ì „ì†¡
4. SEQUENCE1 ì™„ë£Œ â†’ RESTART ëŒ€ê¸° ìƒíƒœ í™•ì¸
5. X ë²„íŠ¼ í´ë¦­
```

#### ì˜ˆìƒ ê²°ê³¼
- âœ… Semaphore ëŒ€ê¸°ê°€ ì¦‰ì‹œ í•´ì œë¨
- âœ… "í”„ë¡œê·¸ë¨ ì¢…ë£Œë¡œ RESTART ëŒ€ê¸° ì·¨ì†Œë¨" ë¡œê·¸
- âœ… í”„ë¡œê·¸ë¨ì´ ì¦‰ì‹œ ì¢…ë£Œë¨ (10ë¶„ ëŒ€ê¸° ì•ˆ í•¨)

---

### í…ŒìŠ¤íŠ¸ 4: íŒŒì¼ êµì²´ í…ŒìŠ¤íŠ¸

#### ì ˆì°¨
```
1. OptiX ì‹¤í–‰ â†’ ì¢…ë£Œ
2. ë°±ì—…í•œ ë‹¤ë¥¸ ë²„ì „ OptiX.exeë¥¼ ê°™ì€ í´ë”ì— ë³µì‚¬
3. ë³µì‚¬ ì„±ê³µ ì—¬ë¶€ í™•ì¸
4. ìƒˆ ë²„ì „ ì‹¤í–‰ â†’ í¬íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸
```

#### ì˜ˆìƒ ê²°ê³¼
- âœ… íŒŒì¼ ë³µì‚¬ ì„±ê³µ (ì ê¹€ ì˜¤ë¥˜ ì—†ìŒ)
- âœ… ìƒˆ ë²„ì „ ì‹¤í–‰ ì‹œ í¬íŠ¸ ì •ìƒ ì—°ê²°

---

### í…ŒìŠ¤íŠ¸ 5: í†µì‹  ì„œë²„ ì‹¤í–‰ ì¤‘ ì¢…ë£Œ

#### ì ˆì°¨
```
1. OptiX ì‹¤í–‰
2. Settings â†’ TCP ì„œë²„ ì‹œì‘ (7777 í¬íŠ¸)
3. Client ì—°ê²° í™•ì¸ (AUTO MODE í‘œì‹œ)
4. X ë²„íŠ¼ í´ë¦­
5. PowerShellì—ì„œ netstat í™•ì¸
```

#### ì˜ˆìƒ ê²°ê³¼
- âœ… ì„œë²„ê°€ ì •ìƒ ì¢…ë£Œë¨
- âœ… `netstat -ano | findstr :7777` ê²°ê³¼ ì—†ìŒ
- âœ… Clientì— SERVER_SHUTDOWN ë©”ì‹œì§€ ì „ì†¡ë¨

---

## ğŸ“ ìš´ì˜ í”„ë¡œí† ì½œ ëŒ€ê¸° í™•ì¸ ë°©ë²•

### 1. ë¡œê·¸ ë¶„ì„

**í™•ì¸ í¬ì¸íŠ¸**:
```
[OpticSeqExecutor] â¸ï¸ SEQUENCE1 ì™„ë£Œ - RESTART ëª…ë ¹ ëŒ€ê¸° ì¤‘...
[OpticSeqExecutor] â–¶ï¸ RESTART ëª…ë ¹ ìˆ˜ì‹  ì™„ë£Œ
```

**ë¹„ì •ìƒ ì¼€ì´ìŠ¤**:
```
[OpticSeqExecutor] â±ï¸ RESTART ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ (600ì´ˆ) - í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨
```

â†’ 600ì´ˆ(10ë¶„) ëŒ€ê¸° í›„ì—ë„ ì¢…ë£Œë˜ì§€ ì•Šìœ¼ë©´ **í”„ë¡œí† ì½œ ëŒ€ê¸°ê°€ ì¢…ë£Œë¥¼ ë§‰ê³  ìˆìŒ**

---

### 2. ë””ë²„ê±° ìŠ¤ë ˆë“œ ë¶„ì„

**Visual Studio ë””ë²„ê±°**:
```
1. RESTART ëŒ€ê¸° ìƒíƒœì—ì„œ "ë””ë²„ê·¸ â†’ í”„ë¡œì„¸ìŠ¤ì— ì—°ê²°"
2. "ë””ë²„ê·¸ â†’ ëª¨ë‘ ì¤‘ë‹¨"
3. "ë””ë²„ê·¸ â†’ ì°½ â†’ ìŠ¤ë ˆë“œ" ì—´ê¸°
4. Call Stack í™•ì¸
```

**ì°¾ì„ ë‚´ìš©**:
- `SemaphoreSlim.WaitAsync` ë©”ì„œë“œê°€ Call Stackì— ìˆëŠ”ì§€
- `CancellationToken`ì´ ì·¨ì†Œë˜ì§€ ì•Šì•˜ëŠ”ì§€

---

### 3. ìˆ˜ì • ì „í›„ ë¹„êµ

#### ìˆ˜ì • ì „ (ë¬¸ì œ ìƒí™©)
```csharp
await restartSemaphore.WaitAsync(cts.Token); // âŒ ì™¸ë¶€ ì·¨ì†Œ ë¶ˆê°€
```

â†’ í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ì´ ì§€ì ì—ì„œ **ìµœëŒ€ 10ë¶„ ëŒ€ê¸°**

#### ìˆ˜ì • í›„ (í•´ê²°)
```csharp
var linkedCts = CancellationTokenSource.CreateLinkedTokenSource(
    cancellationToken,  // âœ… í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ì·¨ì†Œë¨
    new CancellationTokenSource(TimeSpan.FromSeconds(timeoutSeconds)).Token
);
await restartSemaphore.WaitAsync(linkedCts.Token);
```

â†’ í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ `cancellationToken.Cancel()` í˜¸ì¶œ â†’ **ì¦‰ì‹œ OperationCanceledException ë°œìƒ** â†’ ëŒ€ê¸° í•´ì œ

---

## ğŸ”§ ì¶”ê°€ ê°œì„  ì‚¬í•­

### 1. í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ ë°©ì§€

**Environment.Exit(0) ì‚¬ìš© ê¸ˆì§€**:
- WPFëŠ” `Application.Current.Shutdown()` ì‚¬ìš©
- `OnExit` ì´ë²¤íŠ¸ë¥¼ í†µí•´ ì •ìƒì ì¸ ì •ë¦¬ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰

---

### 2. ë¡œê·¸ ë ˆë²¨ ìƒì„¸í™”

**ì¢…ë£Œ ê´€ë ¨ ë¡œê·¸**:
```csharp
ErrorLogger.Log("========== í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œì‘ ==========", ErrorLogger.LogLevel.INFO);
ErrorLogger.Log("1ë‹¨ê³„: ì·¨ì†Œ í† í° ë°œìƒ", ErrorLogger.LogLevel.DEBUG);
ErrorLogger.Log("2ë‹¨ê³„: Timer ì •ë¦¬ ì™„ë£Œ", ErrorLogger.LogLevel.DEBUG);
ErrorLogger.Log("3ë‹¨ê³„: í†µì‹  ì„œë²„ ì¢…ë£Œ ì™„ë£Œ", ErrorLogger.LogLevel.DEBUG);
// ...
ErrorLogger.Log("========== í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì™„ë£Œ ==========", ErrorLogger.LogLevel.INFO);
```

---

### 3. ë””ë²„ê·¸ ë¹Œë“œ vs ë¦´ë¦¬ì¦ˆ ë¹Œë“œ

**ë””ë²„ê·¸ ë¹Œë“œ**:
- ëª¨ë“  ì¢…ë£Œ ë‹¨ê³„ë¥¼ `Debug.WriteLine`ìœ¼ë¡œ ì¶œë ¥
- Visual Studio Output ì°½ì—ì„œ ì‹¤ì‹œê°„ í™•ì¸

**ë¦´ë¦¬ì¦ˆ ë¹Œë“œ**:
- ErrorLoggerë¥¼ í†µí•´ íŒŒì¼ì— ê¸°ë¡
- ë°°í¬ í›„ í˜„ì¥ì—ì„œ ë¬¸ì œ ë°œìƒ ì‹œ ë¡œê·¸ ë¶„ì„

---

## ğŸ“Œ ìš”ì•½: í•µì‹¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] **Process.dllì— `pg_off()`, `meas_off()`, `cleanup_all_devices()` ì¶”ê°€**
- [ ] **DllManager.csì— P/Invoke ì„ ì–¸ ì¶”ê°€**
- [ ] **DllManager.Dispose()ì—ì„œ `cleanup_all_devices()` í˜¸ì¶œ**
- [ ] **MainWindowì— `shutdownCancellationTokenSource` ì¶”ê°€**
- [ ] **MainWindow.OnClosedì—ì„œ 7ë‹¨ê³„ ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„**
- [ ] **CommunicationServer.Dispose() ì¶”ê°€**
- [ ] **CommunicationServer.StopServerAsync() ê°œì„  (íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬)**
- [ ] **OpticSeqExecutorì— `testCancellationTokenSource` ì¶”ê°€**
- [ ] **OpticSeqExecutor.StartTestAsyncì— CancellationToken ì „ë‹¬**
- [ ] **RESTART ëŒ€ê¸°ì— Linked CancellationToken ì‚¬ìš©**
- [ ] **OpticSeqExecutor.StopAllTests() ë©”ì„œë“œ ì¶”ê°€**
- [ ] **App.OnExitì—ì„œ DLL ë¦¬ì†ŒìŠ¤ í•´ì œ í˜¸ì¶œ**

---

### í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] **ì •ìƒ ì¢…ë£Œ ì‹œ í”„ë¡œì„¸ìŠ¤ê°€ 1ì´ˆ ì´ë‚´ ì¢…ë£Œë˜ëŠ”ì§€**
- [ ] **í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ê°•ì œ ì¢…ë£Œ ì‹œ 3ì´ˆ ì´ë‚´ ì¢…ë£Œë˜ëŠ”ì§€**
- [ ] **RESTART ëŒ€ê¸° ì¤‘ ê°•ì œ ì¢…ë£Œ ì‹œ ì¦‰ì‹œ ì¢…ë£Œë˜ëŠ”ì§€ (10ë¶„ ëŒ€ê¸° ì•ˆ í•¨)**
- [ ] **í”„ë¡œê·¸ë¨ ì¢…ë£Œ í›„ Exe íŒŒì¼ ë®ì–´ì“°ê¸°/ë³µì‚¬ê°€ ì„±ê³µí•˜ëŠ”ì§€**
- [ ] **í”„ë¡œê·¸ë¨ ì¬ì‹¤í–‰ ì‹œ í¬íŠ¸ ì ìœ  ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ì§€**
- [ ] **ì‘ì—… ê´€ë¦¬ìì—ì„œ í”„ë¡œì„¸ìŠ¤ê°€ ë‚¨ì•„ìˆì§€ ì•Šì€ì§€**
- [ ] **netstatì—ì„œ í¬íŠ¸ê°€ ì •ë¦¬ë˜ì—ˆëŠ”ì§€ (7777, PG/MEAS í¬íŠ¸)**

---

## ğŸ“ ê²°ë¡ 

ì´ ê°€ì´ë“œë¥¼ ë”°ë¼ êµ¬í˜„í•˜ë©´:

1. **íŒŒì¼ ì ê¹€ ë¬¸ì œ í•´ê²°**: ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ ì™„ì „ ì •ë¦¬ â†’ í”„ë¡œì„¸ìŠ¤ ì¦‰ì‹œ ì¢…ë£Œ â†’ Exe íŒŒì¼ êµì²´ ê°€ëŠ¥
2. **í¬íŠ¸ ì ìœ  ë¬¸ì œ í•´ê²°**: `pg_off()`/`meas_off()` í˜¸ì¶œ â†’ í•˜ë“œì›¨ì–´ ë¦¬ì†ŒìŠ¤ í•´ì œ â†’ ì¬ì‹¤í–‰ ì‹œ ì •ìƒ ì—°ê²°
3. **ìš´ì˜ í”„ë¡œí† ì½œ ëŒ€ê¸° í•´ê²°**: CancellationTokenìœ¼ë¡œ RESTART ëŒ€ê¸° ì¤‘ë‹¨ â†’ í”„ë¡œê·¸ë¨ ì¦‰ì‹œ ì¢…ë£Œ

**í•µì‹¬ì€ "ì¢…ë£Œ ìˆœì„œ"ì™€ "íƒ€ì„ì•„ì›ƒ"ì…ë‹ˆë‹¤.**  
ëª¨ë“  ë¹„ë™ê¸° ì‘ì—…ì— CancellationTokenì„ ì „ë‹¬í•˜ê³ , íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•˜ë©´ ì•ˆì „í•˜ê²Œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

**ì‘ì„±ì¼**: 2026-02-08  
**ë²„ì „**: 1.0  
**ì‘ì„±ì**: AI Assistant (Claude Sonnet 4.5)
